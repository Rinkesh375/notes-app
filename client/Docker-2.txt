# ------------------------------------------------------------
# ğŸ³ Dockerfile â€” Multi-Stage Build for Frontend App (Vite / Vue / React)
# ------------------------------------------------------------

# ğŸ“¦ STAGE 1: Build Stage
# ------------------------------------------------------------
FROM node:22-alpine AS builder    

# ğŸ“ Set working directory
WORKDIR /app

# ğŸ“¦ Install dependencies
COPY package*.json ./
RUN npm install

# ğŸ“‚ Copy all project files
COPY . .

# âš™ï¸ Declare build-time arguments (used only during build)
ARG VITE_SERVER_URL
ARG VITE_RAZORPAY_KEY_ID
ARG VITE_GA_ID

# ğŸŒ Set them as environment variables during build
ENV VITE_SERVER_URL=$VITE_SERVER_URL
ENV VITE_RAZORPAY_KEY_ID=$VITE_RAZORPAY_KEY_ID
ENV VITE_GA_ID=$VITE_GA_ID

# ğŸ—ï¸ Run production build (creates static files)
RUN npm run build

# ------------------------------------------------------------
# ğŸš€ STAGE 2: Production Stage
# ------------------------------------------------------------
FROM node:22-alpine AS production

# ğŸ“ Set working directory
WORKDIR /app

# ğŸŒ Install static file server
RUN npm install -g serve

# ğŸ“‚ Copy built frontend files from builder stage
COPY --from=builder /app/dist ./dist

# ğŸŒ Declare runtime environment variables (for visibility)
# These can be overridden with `-e` when running the container
ENV RUNTIME_SERVER_URL=""
ENV RUNTIME_RAZORPAY_KEY_ID=""
ENV RUNTIME_GA_ID=""

# ğŸ”“ Expose app port
EXPOSE 3000

# â–¶ï¸ Serve static files
CMD ["serve", "-s", "dist", "-l", "3000"]

# ------------------------------------------------------------
# ğŸ§  Notes:
# ------------------------------------------------------------
# - ARG â†’ available only during build
# - ENV â†’ visible at runtime
# - Static files are already built with values from ARG (build-time)
# - You can override ENV at runtime, but frontend must read them dynamically
# ------------------------------------------------------------
