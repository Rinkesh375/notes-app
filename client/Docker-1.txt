# ------------------------------------------------------------
# ğŸ³ Dockerfile â€” Multi-Stage Build for Frontend (Vite / Vue / React)
# ğŸ“¦ Version: Runtime Environment Enabled
# ------------------------------------------------------------

# ------------------------------------------------------------
# ğŸ§© STAGE 1 â€” Build Stage
# ------------------------------------------------------------
FROM node:22-alpine AS builder

# ğŸ“ Set working directory inside the container
WORKDIR /app

# ğŸ“¦ Copy dependency files and install dependencies
COPY package*.json ./
RUN npm install

# ğŸ“‚ Copy project files into the container
COPY . .

# âš™ï¸ Declare optional build-time variables (used for default values)
# These are only available during the build process â€” not runtime.
ARG DEFAULT_SERVER_URL
ARG DEFAULT_RAZORPAY_KEY_ID

# ğŸŒ Set environment variables (used during `npm run build`)
ENV VITE_SERVER_URL=$DEFAULT_SERVER_URL
ENV VITE_RAZORPAY_KEY_ID=$DEFAULT_RAZORPAY_KEY_ID

# ğŸ—ï¸ Build the app (output in /dist)
RUN npm run build

# ------------------------------------------------------------
# ğŸš€ STAGE 2 â€” Production Stage
# ------------------------------------------------------------
FROM node:22-alpine AS production

# ğŸ“ Set working directory
WORKDIR /app

# ğŸŒ Install a lightweight static server
RUN npm install -g serve

# ğŸ“‚ Copy built frontend files from builder stage
COPY --from=builder /app/dist ./dist

# ------------------------------------------------------------
# ğŸ§  Runtime Environment Variables
# ------------------------------------------------------------
# These can be overridden when starting the container using `-e` flags.
# Example:
# docker run -it -p 6000:3000 \
#   -e RUNTIME_SERVER_URL="https://api.example.com" \
#   -e RUNTIME_RAZORPAY_KEY_ID="rzp_live_ABC123" \
#   --name my-runtime-app vue-runtime-app
#
# You can then view them inside the container:
# docker exec -it my-runtime-app sh
# printenv | grep RUNTIME

ENV RUNTIME_SERVER_URL="https://default-api.example.com"
ENV RUNTIME_RAZORPAY_KEY_ID="rzp_test_default"

# ------------------------------------------------------------
# ğŸ”“ Expose port (for local-machine access)
EXPOSE 3000

# ------------------------------------------------------------
# â–¶ï¸ Start the app (serve static files)
CMD ["serve", "-s", "dist", "-l", "3000"]

# ------------------------------------------------------------
# ğŸ§© BUILD COMMAND (for future reference)
# ------------------------------------------------------------
# docker build \
#   --build-arg DEFAULT_SERVER_URL="https://dev-api.example.com" \
#   --build-arg DEFAULT_RAZORPAY_KEY_ID="rzp_test_123456" \
#   -t vue-runtime-app .
#
# ğŸ§© RUN COMMAND (runtime env vars override defaults)
# docker run -it --rm -p 6000:3000 \
#   -e RUNTIME_SERVER_URL="https://prod-api.example.com" \
#   -e RUNTIME_RAZORPAY_KEY_ID="rzp_live_ABC123" \
#   --name my-runtime-app vue-runtime-app
# ------------------------------------------------------------

