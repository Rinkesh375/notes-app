#  ------------------------------------------------------------
#  ğŸ³ Dockerfile â€” Multi-Stage Build for Frontend App (Vite / Vue / React)
#  ------------------------------------------------------------

#  ğŸ“¦ STAGE 1: Build Stage
#  ------------------------------------------------------------

# ğŸ§© Use lightweight Node.js image (Alpine = minimal size)
FROM node:22-alpine AS builder    

# ğŸ“ Set working directory inside the container
WORKDIR /app

# ğŸ“¦ Copy dependency files and install dependencies
COPY package*.json ./
RUN npm install

# ğŸ“‚ Copy all project files into the container
COPY . .

# âš™ï¸ Declare build-time arguments (passed via `--build-arg`)
ARG VITE_SERVER_URL
ARG VITE_RAZORPAY_KEY_ID
ARG VITE_GA_ID

# ğŸŒ Set environment variables inside container
# (These are embedded at build-time and available during `npm run build`)
ENV VITE_SERVER_URL=$VITE_SERVER_URL
ENV VITE_RAZORPAY_KEY_ID=$VITE_RAZORPAY_KEY_ID
ENV VITE_GA_ID=$VITE_GA_ID

# ğŸ—ï¸ Run production build (generates static files in /dist)
RUN npm run build

# ------------------------------------------------------------
#  ğŸš€ STAGE 2: Production Stage
#  ------------------------------------------------------------

# ğŸ§© Use fresh Node image for running the built app
FROM node:22-alpine AS production

# ğŸ“ Create a clean working directory
WORKDIR /app

# ğŸŒ Install "serve" globally â€” a lightweight static file server
RUN npm i -g serve

# ENV PATH="/usr/local/bin:$PATH"

# ğŸ“‚ Copy built files from the previous stage (builder â†’ production)
COPY --from=builder /app/dist ./dist

# ğŸ”“ Expose port 3000 (the port the app will run on)
EXPOSE 3000

# â–¶ï¸ Start the app using "serve" to serve static files from /dist
CMD ["serve", "-s", "dist", "-l", "3000"]

# ------------------------------------------------------------
#  ğŸ§  Summary:
#  ------------------------------------------------------------
#  1ï¸âƒ£ builder stage â†’ builds optimized static files
#  2ï¸âƒ£ production stage â†’ serves those files using "serve"
#  ------------------------------------------------------------ 



# ğŸ§© Use this command to build the Docker image with all env vars
# docker build \
#     --build-arg VITE_SERVER_URL="http://localhost:4000" \
#     --build-arg VITE_RAZORPAY_KEY_ID="rzp_test_123456" \
#     --build-arg VITE_GA_ID="G-123ABC" \
#     -t my-vue-app .

# ğŸ“¦ Explanation:
# --build-arg â†’ passes environment variables at build-time
# -t my-vue-app â†’ names the built image
# . â†’ means build context is the current directory    
